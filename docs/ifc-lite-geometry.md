<!--
  This Source Code Form is subject to the terms of the Mozilla Public
  License, v. 2.0. If a copy of the MPL was not distributed with this
  file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

## IFC-Lite Geometry Artifacts (LOD0 + LOD1)

This document defines the **artifact formats** generated by IFC-Lite for progressive viewing:

- **LOD0**: **placement-based bounding boxes JSON** (fast, no tessellation)
- **LOD1**: **mesh geometry GLB** + **meta JSON** (best-effort; always produces an artifact)

### Artifact naming conventions

- **LOD0**: `lod0_preview.json`
- **LOD1 mesh**: `lod1.glb`
- **LOD1 meta**: `lod1.meta.json`

### LOD0 (`lod0_preview.json`) — bbox JSON (MANDATORY)

LOD0 is computed from **IfcLocalPlacement accumulation** (world transform) and best-available bounding box dimensions.

#### JSON schema (contract)

```json
{
  "schema": "ifc-lite-geometry",
  "lod": 0,
  "units": "m",
  "elements": [
    {
      "expressID": 123,
      "globalId": "2O2Fr$...optional...",
      "ifcClass": "IfcWall",
      "name": "Wall A",
      "transform": [16],
      "bbox": { "min": [0, 0, 0], "max": [1, 1, 1] },
      "centroid": [0.5, 0.5, 0.5],
      "bbox_source": "shape"
    }
  ]
}
```

Notes:

- **`transform`** is a **row-major** \(4\times4\) world matrix.
- **`bbox`** is a **world-space AABB**.
- **`bbox_source`** is always present:
  - `"shape"`: derived from IFC `IfcBoundingBox` (via `IfcShapeRepresentation` / `IfcProductDefinitionShape`)
  - `"fallback"`: no bbox available ⇒ uses a small default cube (0.2m)

### LOD1 (`lod1.glb` + `lod1.meta.json`) — mesh (MANDATORY)

LOD1 is generated via best-effort meshing. The pipeline must **always** emit:

- a `lod1.glb` file (even if it is only fallback boxes), and
- a `lod1.meta.json` file describing status and failures.

#### Meta JSON schema (`lod1.meta.json`)

```json
{
  "schema": "ifc-lite-geometry",
  "lod": 1,
  "status": "ok",
  "failedElements": [],
  "notes": [],
  "mapping": {
    "123": { "node": 0, "mesh": 0 }
  }
}
```

Fields:

- **`status`**:
  - `"ok"`: meshing succeeded without detected gaps
  - `"degraded"`: partial mesh output, or fallback mode
- **`failedElements`**: array of IFC `expressID`s that did not produce mesh output.
- **`mapping`**: at minimum, `expressID -> { node, mesh }` mapping for picking/highlight.
- **`fallback`** (optional): present only when fallback GLB was generated.

#### Mandatory fallback behavior

If full meshing fails, IFC-Lite will generate a fallback GLB using **boxes from LOD0** and write:

```json
{
  "status": "degraded",
  "fallback": "boxes_from_lod0"
}
```

### Performance notes (why LOD0 avoids tessellation)

LOD0 must be fast for huge IFC files. It avoids tessellation by:

- scanning + extracting only what’s required for placement and bbox dimensions
- generating world transforms from placements
- never building triangle meshes

